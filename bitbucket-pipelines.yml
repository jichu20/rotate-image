# This is a sample build configuration for Python.
# Check our guides at https://confluence.atlassian.com/x/x4UWN for more examples.
# Only use spaces to indent your .yml configuration.
# -----
# You can specify a custom docker image from Docker Hub as your build environment.
image: python:3.7.3

pipelines:
  default:
    - step:
        name: install dependencies
        caches:
          - pip
        script: # Modify the commands below to build your repository.
          - pip install -r requirements.txt
          - pip install pep8
          - pip install --upgrade pep8
    - step:
        name: check pep8
        caches:
          - pip
        script: # Modify the commands below to build your repository.
          - pip install flake8
          - flake8 --max-line-length=120 --ignore=E402,W503,E722 .

  branches:
    master:
      - step:
          name: install dependencies
          caches:
            - pip
          script: # Modify the commands below to build your repository.
            - pip install -r requirements.txt
            - pip install pep8
            - pip install --upgrade pep8
      - step:
          name: check pep8
          caches:
            - pip
          script: # Modify the commands below to build your repository.
            - pip install flake8
            - flake8 --max-line-length=120 --ignore=E402,W503,E722 .
      - step: # Construcci칩n de la im치gen docker
          name: build docker image
          services:
            - docker
          script:
            - export IMAGE_NAME=jichu20/$PROJECT_NAME
            - docker login --username $DOCKER_HUB_USERNAME --password $DOCKER_HUB_PASSWORD
            - docker build --rm -f "dockerfile" -t $IMAGE_NAME:latest "."
            - docker push $IMAGE_NAME:latest
    develop:
      - step:
          name: install dependencies
          caches:
            - pip
          script: # Modify the commands below to build your repository.
            - pip install -r requirements.txt
            - pip install pep8
            - pip install --upgrade pep8
      - step:
          name: check pep8
          caches:
            - pip
          script: # Modify the commands below to build your repository.
            - pip install flake8
            - flake8 --max-line-length=120 --ignore=E402,W503,E722 .
      - step: # Construcci칩n de la im치gen docker
          name: build docker image
          services:
            - docker
          script:
            - export BITBUCKET_COMMIT_SHORT="${BITBUCKET_COMMIT::7}"
            - export IMAGE_NAME=jichu20/$PROJECT_NAME:$BITBUCKET_COMMIT_SHORT
            - docker login --username $DOCKER_HUB_USERNAME --password $DOCKER_HUB_PASSWORD
            - docker build --rm -f "dockerfile" -t $IMAGE_NAME "."
            - docker push $IMAGE_NAME
    '*':
      - step:
          name: install dependencies
          caches:
            - pip
          script: # Modify the commands below to build your repository.
            - pip install -r requirements.txt
            - pip install pep8
            - pip install --upgrade pep8
      - step:
          name: check pep8
          caches:
            - pip
          script: # Modify the commands below to build your repository.
            - pip install flake8
            - flake8 --max-line-length=120 --ignore=E402,W503,E722 .
  tags:
    '*':
      - step:
          name: install dependencies
          caches:
            - pip
          script: # Modify the commands below to build your repository.
            - pip install -r requirements.txt
            - pip install pep8
            - pip install --upgrade pep8
      - step:
          name: check pep8
          caches:
            - pip
          script: # Modify the commands below to build your repository.
            - pip install flake8
            - flake8 --max-line-length=120 --ignore=E402,W503,E722 .
      - step:
          name: build and publis tag name
          services:
            - docker
          script: # Modify the commands below to build your repository.
            - export IMAGE_NAME=jichu20/$PROJECT_NAME

            # authenticate with the Docker Hub registry
            - docker login --username $DOCKER_HUB_USERNAME --password $DOCKER_HUB_PASSWORD
            # Compilamos y subimos la imagen para el
            - docker build -t $IMAGE_NAME:$BITBUCKET_TAG .
            - docker push $IMAGE_NAME:$BITBUCKET_TAG
      - step:
          name: build and publis latest
          services:
            - docker
          script: # Modify the commands below to build your repository.
            - export IMAGE_NAME=jichu20/$PROJECT_NAME
            # authenticate with the Docker Hub registry
            - docker login --username $DOCKER_HUB_USERNAME --password $DOCKER_HUB_PASSWORD
            # Compilamos y subimos la imagen para el latest
            - docker build -t $IMAGE_NAME:latest .
            - docker push $IMAGE_NAME:latest
    'rpi_*':
      - step:
          name: install dependencies
          caches:
            - pip
          script: # Modify the commands below to build your repository.
            - pip install -r requirements.txt
            - pip install pep8
            - pip install --upgrade pep8
      - step:
          name: check pep8
          caches:
            - pip
          script: # Modify the commands below to build your repository.
            - pip install flake8
            - flake8 --max-line-length=120 --ignore=E402,W503,E722 .
      - step:
          name: build and publis tag name
          services:
            - docker
          script: # Modify the commands below to build your repository.
            - export IMAGE_NAME=jichu20/$PROJECT_NAME

            # authenticate with the Docker Hub registry
            - docker login --username $DOCKER_HUB_USERNAME --password $DOCKER_HUB_PASSWORD
            # Compilamos y subimos la imagen para el
            - docker build -t $IMAGE_NAME:$BITBUCKET_TAG -f "./rpi_dockerfile" "."
            - docker push $IMAGE_NAME:$BITBUCKET_TAG
